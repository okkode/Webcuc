@page "/dashboard"
@attribute [Authorize]

@using GdeWeb.Components.Cards
@using GdeWeb.Components.Layout
@using GdeWeb.Dialogs
@using GdeWeb.Interfaces
@using GdeWebModels
@using Microsoft.AspNetCore.Authorization

@inject ITrainingService trainingService
@inject IDialogService dialogService
@inject ISnackbarService snackbarService
@inject INoteService noteService
@inject NavigationManager navigationManager

@implements IAsyncDisposable

<PageTitle>GDE Edu AI</PageTitle>

<style>
    .fix-search {
        background: var(--mud-palette-background);
    }

    .tl-fixed {
        max-width : 1000px;
        margin-left: auto;
        margin-right: auto;
    }

    /* bal oldali oszlop rögzített szélessége, hogy tényleg a középvonal mellett legyenek */
    .tl-fixed .mud-timeline-item-opposite {
        flex: 0 0 360px;
        max-width: 380px;
    }

    /* Timeline nyilak teljes letiltása (mind bal, mind jobb oldalról) */
    .tl-fixed .mud-timeline-item-content .mud-card::before,
    .tl-fixed .mud-timeline-item-content .mud-card::after {
        content: none !important;
    }

    .tl-center {
        margin-right: auto;
        margin-left: auto;
        width: max-content;
        max-width: 360px;
    }

    .quick-access-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .quick-access-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }
</style>

<div class="main-page">
    @if (!PageLoading)
    {
        <BlazorAnimate.Animate Animation="Animations.ZoomIn" Delay="TimeSpan.FromSeconds(MainLayout.animationDelay)" Duration="TimeSpan.FromSeconds(MainLayout.animationDuration)" style="width: 100%; height:100%;">

            @if (MainLayout.isMobile)
            {
                <style>
                    /* fix szélesség */
                    .element-card {
                        width: 320px;
                    }

                    .element-row {
                        gap: 6px;
                    }

                    .mud-timeline-vertical.mud-timeline-position-start .mud-timeline-item {
                        margin-left: -13px;
                    }

                    .mud-timeline-vertical.mud-timeline-position-start .mud-timeline-item-content, .mud-timeline-vertical.mud-timeline-position-end .mud-timeline-item-content {
                        max-width: calc(100% - 26px);
                    }

                    .mud-timeline-vertical .mud-timeline-item .mud-timeline-item-divider {
                        min-width: 24px;
                    }

                    .mud-timeline-vertical.mud-timeline-position-start::before {
                        left: 0px;
                    }

                    .tl-center {
                        max-width: 320px;
                    }
                </style>

                <div class="card-max">

                    <!-- Kereső + kategória-szűrő (meglévő) -->
                    <div class="fix-search">

                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 2)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                            <MudText Typo="Typo.h4" Class="font-bold text-center mt-3 mb-3">
                                Tanulj Mesterséges Intelligenciával gyorsan és játékosan
                            </MudText>

                        </BlazorAnimate.Animate>

                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 3)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                            <div class="search">
                                <MudTextField @bind-Value="searchText"
                                              Placeholder="Keresés"
                                              Clearable="true"
                                              Variant="Variant.Text"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Immediate="true"
                                              OnKeyUp="FilterCourses" />
                            </div>

                        </BlazorAnimate.Animate>

                        <!-- Quick Access Cards for Notes and Summaries -->
                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 4)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">
                            <MudGrid Spacing="2" Justify="Justify.Center" Class="mt-3 mb-3">
                                <MudItem xs="12" sm="6" md="6">
                                    <MudCard Class="quick-access-card" Elevation="2" Style="cursor: pointer; height: 100%;" @onclick="@(() => MainLayout.GoTo("/summaries"))">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Size="Size.Large" Style="background: var(--mud-palette-primary);">
                                                        <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="Size.Large" />
                                                    </MudAvatar>
                                                    <MudStack>
                                                        <MudText Typo="Typo.h6" Class="font-weight-bold">Havi összefoglalók</MudText>
                                                        <MudText Typo="Typo.body2" Class="text-muted">AI által generált havi összefoglalók</MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="6">
                                    <MudCard Class="quick-access-card" Elevation="2" Style="cursor: pointer; height: 100%;" @onclick="@(() => OpenAllNotesDialog())">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Size="Size.Large" Style="background: var(--mud-palette-secondary);">
                                                        <MudIcon Icon="@Icons.Material.Filled.Note" Size="Size.Large" />
                                                    </MudAvatar>
                                                    <MudStack>
                                                        <MudText Typo="Typo.h6" Class="font-weight-bold">Jegyzeteim</MudText>
                                                        <MudText Typo="Typo.body2" Class="text-muted">
                                                            @(notesCount > 0 ? $"{notesCount} jegyzet" : "Összes jegyzet megtekintése")
                                                        </MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            </MudGrid>
                        </BlazorAnimate.Animate>
                        
                    </div>

                    <!-- MudTimeline -->
                    <MudTimeline Class="tl-fixed"
                                 TimelineOrientation="TimelineOrientation.Vertical"
                                 TimelinePosition="TimelinePosition.Left">

                        @for (int i = 0; i < filteredCourses.Count; i++)
                        {
                            var course = filteredCourses[i];

                            <MudTimelineItem Color="Color.Primary">
                                <ItemContent>
                                    <!-- Jobb oldal: ElementCard -->
                                    <div class="tl-center">
                                        <BlazorAnimate.Animate Animation="Animations.FadeIn"
                                                               Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * (i))"
                                                               Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                                            <CourseCard Course="course" Editor="false" ChangeModifyMethod="LoadData" />

                                        </BlazorAnimate.Animate>
                                    </div>
                                </ItemContent>
                            </MudTimelineItem>
                        }

                    </MudTimeline>

                </div>
            }
            else
            {
                <style>
                    /* fix szélesség */
                    .element-card {
                        width: 360px;
                    }
                </style>

                <div class="card-max-desktop">

                    <div class="fix-search">

                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 2)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                            <MudText Typo="Typo.h4" Class="font-bold text-center mt-3 mb-3">
                                Tanulj Mesterséges Intelligenciával gyorsan és játékosan
                            </MudText>

                        </BlazorAnimate.Animate>

                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 3)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                            <div class="search">
                                <MudTextField @bind-Value="searchText"
                                              Placeholder="Keresés"
                                              Clearable="true"
                                              Variant="Variant.Text"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              Immediate="true"
                                              OnKeyUp="FilterCourses" />
                            </div>

                        </BlazorAnimate.Animate>

                        <!-- Quick Access Cards for Notes and Summaries -->
                        <BlazorAnimate.Animate Animation="Animations.SlideDown" Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * 4)" Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">
                            <MudGrid Spacing="2" Justify="Justify.Center" Class="mt-3 mb-3">
                                <MudItem xs="12" sm="6" md="6">
                                    <MudCard Class="quick-access-card" Elevation="2" Style="cursor: pointer; height: 100%;" @onclick="@(() => MainLayout.GoTo("/summaries"))">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Size="Size.Large" Style="background: var(--mud-palette-primary);">
                                                        <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="Size.Large" />
                                                    </MudAvatar>
                                                    <MudStack>
                                                        <MudText Typo="Typo.h6" Class="font-weight-bold">Havi összefoglalók</MudText>
                                                        <MudText Typo="Typo.body2" Class="text-muted">AI által generált havi összefoglalók</MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="6">
                                    <MudCard Class="quick-access-card" Elevation="2" Style="cursor: pointer; height: 100%;" @onclick="@(() => OpenAllNotesDialog())">
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Size="Size.Large" Style="background: var(--mud-palette-secondary);">
                                                        <MudIcon Icon="@Icons.Material.Filled.Note" Size="Size.Large" />
                                                    </MudAvatar>
                                                    <MudStack>
                                                        <MudText Typo="Typo.h6" Class="font-weight-bold">Jegyzeteim</MudText>
                                                        <MudText Typo="Typo.body2" Class="text-muted">
                                                            @(notesCount > 0 ? $"{notesCount} jegyzet" : "Összes jegyzet megtekintése")
                                                        </MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            </MudGrid>
                        </BlazorAnimate.Animate>

                    </div>

                    <!-- MudTimeline -->
                    <MudTimeline Class="tl-fixed"
                                 TimelineOrientation="TimelineOrientation.Vertical"
                                 TimelinePosition="TimelinePosition.Alternate">

                        @for (int i = 0; i < filteredCourses.Count; i++)
                        {
                            var course = filteredCourses[i];

                            <MudTimelineItem Color="Color.Primary">
                                <ItemContent>
                                    <!-- Jobb oldal: ElementCard -->
                                    <div class="tl-center">
                                        <BlazorAnimate.Animate Animation="Animations.FadeIn"
                                                               Delay="@TimeSpan.FromSeconds(MainLayout.animationDelay * (i))"
                                                               Duration="@TimeSpan.FromSeconds(MainLayout.animationDuration)">

                                            <CourseCard Course="course" Editor="false" ChangeModifyMethod="LoadData" />

                                        </BlazorAnimate.Animate>
                                    </div>
                                </ItemContent>
                            </MudTimelineItem>
                        }
                    </MudTimeline>

                </div>
            }

        </BlazorAnimate.Animate>

    }
    else
    {
        <!-- LOADING -->
        <div class="loading-center">
            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
        </div>
    }

</div>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; } = default!;

    // LOADING PARAMETERS
    private bool PageLoading = true; // true

    //SEARCH TEXT
    private string searchText = string.Empty;

    // COURSE LIST
    private List<CourseModel> CourseList = new List<CourseModel>();

    // FILTERED COURSES
    private List<CourseModel> filteredCourses = new List<CourseModel>();

    // NOTES COUNT
    private int notesCount = 0;

    /// <summary>
    /// PAGE LOAD
    /// </summary>
    #region PAGE LOAD
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            PageLoading = false;

            await LoadData();
            await LoadNotesCount();

            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private bool _subscribed = false;

    private async Task HandleCourseViewed()
    {
        await LoadData();
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (MainLayout is not null && !_subscribed)
        {
            MainLayout.CourseViewed += HandleCourseViewed;
            _subscribed = true;
        }
        base.OnParametersSet();
    }

    public ValueTask DisposeAsync()
    {
        if (MainLayout is not null && _subscribed)
            MainLayout.CourseViewed -= HandleCourseViewed;

        return ValueTask.CompletedTask;
    }
    #endregion

    /// <summary>
    /// REFRESH METHODES
    /// </summary>
    #region REFRESH METHODES
    private async Task LoadData()
    {
        await Task.Delay(10);

        CourseListModel listModel = await trainingService.GetCourseList();
        if (listModel.Result.Success)
        {
            CourseList = listModel.CourseList.Where(w => !string.IsNullOrEmpty(w.CourseTitle)).ToList();
        }
        else
        {
            snackbarService.ShowSnackbar(Severity.Error, $"Hiba történt a betöltés során: {listModel.Result.ErrorMessage.ToString()}", MainLayout.pageWidth);
        }

        KeyboardEventArgs args = new KeyboardEventArgs();
        FilterCourses(args);

        StateHasChanged();
    }
    #endregion


    /// <summary>
    /// FILTER METHODES
    /// </summary>
    #region FILTER METHODES
    private void FilterCourses(KeyboardEventArgs args)
    {
        filteredCourses = CourseList.Where(x =>
            x.CourseTitle.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            x.CourseDescription.Contains(searchText, StringComparison.OrdinalIgnoreCase)).ToList();

        StateHasChanged();
    }
    #endregion

    /// <summary>
    /// LOAD NOTES COUNT
    /// </summary>
    #region LOAD NOTES COUNT
    private async Task LoadNotesCount()
    {
        try
        {
            var result = await noteService.GetUserNotes();
            if (result.Result.Success)
            {
                notesCount = result.Count;
            }
        }
        catch
        {
            notesCount = 0;
        }
    }
    #endregion

    /// <summary>
    /// OPEN ALL NOTES DIALOG
    /// </summary>
    #region OPEN ALL NOTES DIALOG
    private async Task OpenAllNotesDialog()
    {
        // Navigate to a notes page or show a dialog with all notes
        // For now, we'll create a simple dialog showing all notes
        var parameters = new DialogParameters();
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await dialogService.ShowAsync<AllNotesDialog>("Összes jegyzet", parameters, options);
        await dialog.Result;
        await LoadNotesCount();
        StateHasChanged();
    }
    #endregion
}
